@if (Visible)
{
    <div class="modal-overlay" id="modal">
        <div class="modal-cinema">
            <button class="close-button" @onclick="OnClose">X</button>

            <div class="date-selector">
                <span class="selected">Today</span>
            </div>

            <h3>Selecione Os Lugares</h3>

            <div class="seat-map">
                <div class="screen">Screen</div>
                <div class="seats">
                    @for (int i = 0; i < 7; i++)
                    {
                        var row = i;
                        <div class="row">
                            @((char)('A' + row))
                            @for (int j = 0; j < 5; j++)
                            {
                                var col = j;
                                var seatLabel = $"{(char)('A' + row)}{col + 1}";
                                var isOccupied = OccupiedSeats.Contains(seatLabel);
                                var seatClass = isOccupied ? "reserved" : seatStates[row, col];
                                <span class="seat @seatClass"
                                      @onclick="() => ToggleSeat(row, col)"
                                      disabled="@isOccupied"
                                      style="@((isOccupied ? "pointer-events:none; background:#ccc; cursor:not-allowed;" : ""))">
                                    @seatLabel
                                </span>
                            }
                        </div>
                    }
                </div>
                <div class="legend">
                    <span><span class="legend-dot available"></span> Available</span>
                    <span><span class="legend-dot reserved"></span> Reserved</span>
                    <span><span class="legend-dot selected"></span> Selected</span>
                </div>
            </div>

            <div class="ticket-count">
                <div>
                    Persons: 
                     @AdultsCount 
                </div>
            </div>

            <div class="total">Total: @TotalPrice.ToString("0.00") $</div>

            <div class="actions">
                <button class="add-cart" @onclick="AddToCart">Adicionar to cart</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public double Price { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<(int Adults,  List<string> Seats)> OnAddToCart { get; set; }
    [Parameter] public string[] OccupiedSeats { get; set; } = Array.Empty<string>();

    public double TotalPrice => Price * AdultsCount;

    private int AdultsCount { get; set; } = 1;
    private string[,] seatStates = new string[7, 5]; 
    private List<string> SelectedSeats { get; set; } = new List<string>();

    protected override void OnInitialized()
    {
        for (int i = 0; i < 7; i++)
            for (int j = 0; j < 5; j++)
            {
                var seatLabel = $"{(char)('A' + i)}{j + 1}";
                seatStates[i, j] = OccupiedSeats.Contains(seatLabel) ? "reserved" : "available";
            }
    }

    private void ToggleSeat(int row, int col)
    {
        var seatLabel = $"{(char)('A' + row)}{col + 1}";
        if (seatStates[row, col] == "available")
        {
            seatStates[row, col] = "selected";
            SelectedSeats.Add(seatLabel);
        }
        else if (seatStates[row, col] == "selected")
        {
            seatStates[row, col] = "available";
            SelectedSeats.Remove(seatLabel);
        }
    }

    private async Task AddToCart()
    {
        if (OnAddToCart.HasDelegate)
            await OnAddToCart.InvokeAsync((AdultsCount, SelectedSeats));
    }
}