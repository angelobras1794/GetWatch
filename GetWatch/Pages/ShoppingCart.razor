@page "/ShoppingCart"
@attribute [Authorize]
@using GetWatch.Pages.Layout
@using GetWatch.Pages
@layout ShoppingCartPageLayout
@using GetWatch.Services.ShoppingCart
@using GetWatch.Services.Db
@using System.Security.Claims
@using GetWatch.Services.Movies
@using GetWatch.Services.Movies.Strategy
@using GetWatch.Interfaces.Movies
@using GetWatch.Interfaces.User
@using GetWatch.Interfaces.ShoppingCart
@using GetWatch.Interfaces.Db
@using GetWatch.Services
@using GetWatch.Services.Proxy
@using GetWatch.Interfaces.Proxy
@using GetWatch.Interfaces.Compra
@using GetWatch.Interfaces.Mediator
@inject CustomAuthenticationStateProvider AuthenticationStateProvider ;
@inject IMovieRepository MovieRepository
@inject IUnitOfWork UnitOfWork
@inject IUserMapper UserMapper
@inject ICartItemFactory CartItemFactory
@inject UserService UserService
@inject IShoppingCartMapper ShoppingCartMapper
@inject ICommandManager CommandManager
@inject IGetWatchMediator GetWatchMediator
@inject ICartItemMapper CartItemMapper


<NavBar />
<div class="progress-container">
    <div class="progress-bar">
        <div class="progress-completed" id="progress-completed"></div>
    </div>

    <div class="progress-steps">
        <div class="step @(step > 1 ? "completed" : "")" data-step="1">
            <div class="step-marker">1</div>
            <div class="step-name">Cart</div>
        </div>


        <div class="step @(step > 2 ? "completed" : "")" data-step="2">
            <div class="step-marker">2</div>
            <div class="step-name">Payment</div>
        </div>

        <div class="step" data-step="3">
            <div class="step-marker">3</div>
            <div class="step-name">Confirm</div>
        </div>
    </div>
</div>

<div class="cart-container">
    @if(step == 1){

        @if (realUser?.Cart != null && realUser.Cart.GetItems().Any() )
        {
            @foreach (var item in realUser.Cart.GetItems())
            {
                <div class="cart-item">
                    <div class="item-info">
                        <div class="item-title">@getItemType(item)</div>
                    </div>
                    <div class="item-quantity">
                        <button class="quantity-btn" @onclick="() => removeQuantity(item)">-</button>
                        <span>@item.Quantity</span>
                        <button class="quantity-btn" @onclick="() => addQuantity(item)">+</button>
                    </div>
                    <div class="item-price">â‚¬@(item.Price )</div>
                    <button class="remove-btn" @onclick="() => RemoveItem(item)" >Remove</button>
                </div>
                
            }
        }
        else
        {
            <div class="cart-empty">Your cart is empty.</div>
        }
        @if (realUser?.Cart != null)
        {
            <div class="cart-total">
                <span>Total</span>
                <span>@realUser.Cart.Price</span>
            </div>
            <div class="div-container">
                <button disabled="@UndoDisabled" class="round-button grey-button" @onclick="Undo">Undo</button>
                <button disabled="@RedoDisabled" class="round-button grey-button" @onclick="Redo">Redo</button>
            </div>
        }
    }else if(step == 2){
        <PaymentCard realUser="realUser" OnCardSelected="(cardNum) => SelectedCardNumber = cardNum"/>
    }
    else if(step == 3){
        <FinalCart realUser="realUser" GetItemType="getItemType"/>
    }
          
    @if(step !=3){
        <button class="button" @onclick="nextStep">Next step</button>
    }
    @if(step != 1){
        <button class="button" @onclick="previousStep">Back</button>
    }
    
</div>
<Footer/>




@code{
    
    private IRepository<DbUser>? UserRepository;
    private IUser? realUser;
    private bool isAuthenticated = false;
    private Dictionary<int, string> movieTitles = new();
    private string? SelectedCardNumber { get; set; }

    private ProxyCart ?cartItemList;

    int step = 1;

    protected override async Task OnInitializedAsync(){
        var user = await UserService.GetAuthenticatedUserAsync();

        realUser = UserMapper.Get(user.Id);
        if (realUser?.Cart != null)
        {
            var ids = realUser.Cart.GetItems().Select(i => i.movieId).Distinct();
            foreach (var id in ids)
            {
                var movie = await getMovie(id);
                movieTitles[id] = movie?.Title ?? "Unknown";
            }
        }
        cartItemList = new ProxyCart(realUser.Cart,CartItemMapper,ShoppingCartMapper);
    }
    public async Task<PopularApiMovie> getMovie(int id){
            var httpclient = new HttpClient();
            var MovieIdStrategy = new MovieByIdFetchStrategy(id);
            var movieFetcher = new SingleMovieFetcher(MovieIdStrategy);
            var movie = await movieFetcher.FetchMovieAsync(httpclient);
            return movie;
        
        

    }
        public string getItemType(ICartItem item)
    {
        var title = movieTitles.TryGetValue(item.movieId, out var t) ? t : "Unknown";
        return item switch
        {
            RentalProduct => $"Rental Purchase  to {title}",
            BluRayProduct => $"Bluray Purchase to {title}",
            MovieTicketProduct mtp => $"Ticket for {mtp.getPersonAmount()} with seats {string.Join(", ", mtp.getSeats() ?? Array.Empty<string>())} to {title}",
            _ => "Unknown"
        };
    }
    public Task RemoveItem(ICartItem item)
    {
        GetWatchMediator.RemoveFromCart(item,realUser.Cart);
        StateHasChanged();
        return Task.CompletedTask;
    }

    void Redo()
    {
        CommandManager.Redo();
        StateHasChanged();
    }
    void Undo()
    {
        CommandManager.Undo();
        StateHasChanged();
    }

    public bool UndoDisabled => !CommandManager.HasUndo;
    public bool RedoDisabled => !CommandManager.HasRedo;

    public Task addQuantity(ICartItem item)
    {
        cartItemList.UpdateItem(item,true);
        StateHasChanged();
        return Task.CompletedTask;
    }
    public Task removeQuantity(ICartItem item)
    {
        if (item.Quantity > 1)
        {
            
            cartItemList.UpdateItem(item,false);
        }
        else
        {
            GetWatchMediator.RemoveFromCart(item,realUser.Cart);
        }
        StateHasChanged();
        return Task.CompletedTask;
    }

    public Task nextStep()
    {

        if (step == 2){ 
            Console.WriteLine("SelectedCardNumber: " + SelectedCardNumber);
            if (!string.IsNullOrEmpty(SelectedCardNumber))
            {
                step++;
                StateHasChanged();
                
            }
        }
        else if (step == 1){
             step++;
             StateHasChanged();
        }
        return Task.CompletedTask;

    }
    public Task previousStep()
    {
        if (step !=1){
            SelectedCardNumber = null;
            step--;
            StateHasChanged();
            
        }
        return Task.CompletedTask;
        
    }



}